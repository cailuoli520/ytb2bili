# 任务链架构说明

## 概述

项目采用双任务链架构，将视频准备阶段和上传阶段完全分离，实现独立调度和执行。

## 任务链划分

### 1. 下载任务链 (DownloadChainHandler)

**职责**: 负责视频的下载和准备工作

**执行步骤**:
1. 下载YouTube视频
2. 分离音频
3. 生成字幕 (Whisper 或默认方法)
4. 下载封面
5. 翻译字幕
6. 生成元数据 (标题、描述等)

**调度**: 每5秒检查一次待处理任务

**状态流转**: `001` (待处理) → `002` (处理中) → `200` (准备完成) 或 `999` (失败)

### 2. 上传任务链 (UploadScheduler)

**职责**: 负责将准备好的视频上传到Bilibili

**执行步骤**:
1. 上传视频到Bilibili (每小时一个)
2. 等待1小时
3. 上传字幕到Bilibili

**调度**: 每5分钟检查一次是否有待上传任务

**状态流转**: 
- 视频上传: `200` (准备完成) → `201` (上传视频中) → `300` (视频已上传) 或 `299` (上传失败)
- 字幕上传: `300` (视频已上传) → `301` (上传字幕中) → `400` (全部完成) 或 `399` (字幕上传失败)

## 完整状态码定义

| 状态码 | 说明 | 所属阶段 |
|--------|------|---------|
| 001 | 待处理 | 初始状态 |
| 002 | 下载处理中 | 下载任务链 |
| 200 | 下载准备完成 | 下载任务链完成 |
| 201 | 上传视频中 | 上传任务链-视频 |
| 299 | 视频上传失败 | 上传任务链-视频失败 |
| 300 | 视频已上传，待上传字幕 | 上传任务链-等待 |
| 301 | 上传字幕中 | 上传任务链-字幕 |
| 399 | 字幕上传失败 | 上传任务链-字幕失败 |
| 400 | 全部完成 | 最终成功状态 |
| 999 | 下载处理失败 | 下载任务链失败 |

## 任务链独立性

两个任务链完全独立：
- **下载任务链**只负责准备阶段，完成后状态变为 `200`，不会触发上传
- **上传任务链**独立调度，定时查询状态为 `200` 的视频进行上传
- 可以在不上传的情况下批量下载多个视频

## 优势

1. **解耦**: 下载和上传完全分离，互不影响
2. **灵活性**: 可以先批量下载视频，稍后再统一上传
3. **控制**: 每小时只上传一个视频，避免频率限制
4. **容错**: 任一阶段失败不影响另一阶段
5. **可追溯**: 每个阶段都有明确的状态标识

## 使用场景

### 场景1: 批量下载不上传
1. 添加多个YouTube视频URL
2. 系统自动下载并处理到状态 `200`
3. 视频保持在 `200` 状态，不会自动上传

### 场景2: 自动上传流程
1. 视频处理完成到状态 `200`
2. UploadScheduler 每小时自动选择一个视频上传
3. 视频上传成功后1小时自动上传字幕

### 场景3: 手动控制上传
1. 视频处理到状态 `200`
2. 通过API手动触发上传
3. 灵活控制上传时机
