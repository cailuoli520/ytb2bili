# 任务链重构总结

## 重构目标

将原来的单一任务链拆分为两个独立的任务链：
1. **下载任务链**：负责视频下载和准备工作
2. **上传任务链**：负责视频上传到Bilibili

**核心需求**：下载视频时不自动触发上传操作，两个任务链完全解耦。

## 重构内容

### 1. 新增文件

#### `internal/chain_task/download_chain_handler.go`
新建的下载任务链处理器，专门处理视频准备阶段：

**职责**：
- 下载YouTube视频
- 分离音频
- 生成字幕（Whisper 或默认方法）
- 下载封面
- 翻译字幕
- 生成元数据

**调度**：每5秒检查一次待处理任务

**状态流转**：
- `001` (待处理) → `002` (处理中) → `200` (准备完成) 或 `999` (失败)

**特点**：
- 只处理下载准备阶段，不包含任何上传逻辑
- 完成后将视频状态更新为 `200`，不会触发上传
- 支持重试失败的下载步骤

#### `docs/TASK_CHAIN_ARCHITECTURE.md`
任务链架构说明文档，详细描述了：
- 两个任务链的职责划分
- 完整的状态码定义
- 任务链的独立性
- 使用场景说明

### 2. 修改文件

#### `internal/chain_task/upload_scheduler.go`
更新上传调度器：

**新增功能**：
- `resetUploadTasksOnStartup()`: 应用启动时重置上传相关的运行中任务
  - 重置 `201` (上传视频中) → `200` (准备完成)
  - 重置 `301` (上传字幕中) → `300` (视频已上传)

**状态流转**：
- 视频上传: `200` → `201` → `300` 或 `299`
- 字幕上传: `300` → `301` → `400` 或 `399`

#### `internal/core/services/task_step_service.go`
新增两个方法支持任务链分离：

1. `ResetRunningTasksByStepName(stepName string)`: 按步骤名重置运行中任务
2. `GetPendingStepsByNames(stepNames []string)`: 按步骤名列表查询待处理步骤

这两个方法让下载和上传任务链可以独立管理各自的步骤。

#### `main.go`
更新依赖注入：

**修改前**：
```go
fx.Provide(chain_task.NewChainTaskHandler),
fx.Invoke(func(h *chain_task.ChainTaskHandler) {
    h.SetUp()
}),
```

**修改后**：
```go
// 下载任务链处理器
fx.Provide(chain_task.NewDownloadChainHandler),
fx.Invoke(func(h *chain_task.DownloadChainHandler) {
    h.SetUp()
}),

// 上传调度器
fx.Provide(chain_task.NewUploadScheduler),
fx.Invoke(func(s *chain_task.UploadScheduler) {
    s.SetUp()
}),
```

#### `internal/core/types/app_config.go`
添加 `WhisperConfig` 支持：
- 在 `LoadConfig` 的临时结构体中添加 `WhisperConfig` 字段
- 在 `SaveConfig` 的临时结构体中添加 `WhisperConfig` 字段

### 3. 备份文件

`internal/chain_task/chain_task_handler.go.bak`
- 原有的 `ChainTaskHandler` 已重命名为备份文件
- 可以在需要时参考旧实现

## 状态码完整定义

| 状态码 | 说明 | 所属阶段 |
|--------|------|---------|
| 001 | 待处理 | 初始状态 |
| 002 | 下载处理中 | 下载任务链 |
| 200 | 下载准备完成 | 下载任务链完成 |
| 201 | 上传视频中 | 上传任务链-视频 |
| 299 | 视频上传失败 | 上传任务链-视频失败 |
| 300 | 视频已上传，待上传字幕 | 上传任务链-等待 |
| 301 | 上传字幕中 | 上传任务链-字幕 |
| 399 | 字幕上传失败 | 上传任务链-字幕失败 |
| 400 | 全部完成 | 最终成功状态 |
| 999 | 下载处理失败 | 下载任务链失败 |

## 工作流程

### 下载流程
1. 用户添加YouTube视频URL
2. 视频状态初始化为 `001` (待处理)
3. `DownloadChainHandler` 每5秒检查待处理任务
4. 选择一个任务，更新状态为 `002` (处理中)
5. 执行下载任务链的所有步骤
6. 成功后更新状态为 `200` (准备完成)
7. **不会触发上传操作**

### 上传流程
1. `UploadScheduler` 每5分钟检查一次
2. 每小时查找一个状态为 `200` 的视频
3. 更新状态为 `201`，上传视频到Bilibili
4. 成功后更新状态为 `300` (视频已上传)
5. 1小时后，查找状态为 `300` 的视频
6. 更新状态为 `301`，上传字幕
7. 成功后更新状态为 `400` (全部完成)

## 优势

1. **完全解耦**：下载和上传互不影响
2. **灵活控制**：可以批量下载视频而不立即上传
3. **频率限制**：每小时只上传一个视频，避免触发平台限制
4. **容错性强**：任一阶段失败不影响另一阶段
5. **状态清晰**：每个阶段都有明确的状态标识
6. **易于维护**：两个任务链代码分离，各司其职

## 使用场景

### 场景1：批量下载不上传
```
添加10个YouTube视频URL
↓
系统自动下载并处理到状态 200
↓
所有视频保持在 200 状态
↓
不会自动上传（除非手动触发或等待上传调度器）
```

### 场景2：自动上传流程
```
视频处理完成 (状态 200)
↓
UploadScheduler 每小时自动选择一个视频上传 (200→201→300)
↓
视频上传成功后等待1小时
↓
自动上传字幕 (300→301→400)
```

### 场景3：手动控制上传
```
视频处理到状态 200
↓
通过API手动触发上传
↓
灵活控制上传时机和顺序
```

## 测试建议

1. **下载测试**：添加视频URL，验证能正常下载到状态 200 而不触发上传
2. **上传测试**：手动将视频状态改为 200，验证 UploadScheduler 能自动上传
3. **重启测试**：在下载/上传过程中重启应用，验证状态恢复正常
4. **失败测试**：模拟下载/上传失败，验证状态正确更新为失败状态
5. **并发测试**：同时下载多个视频，验证任务链不会互相干扰

## 注意事项

1. **状态一致性**：确保数据库中的视频状态与任务步骤状态保持一致
2. **错误处理**：下载和上传失败都有对应的失败状态 (999, 299, 399)
3. **重试机制**：失败的步骤会自动标记为 pending，等待重试
4. **时间控制**：上传调度器严格控制每小时一个视频，避免频率限制

## 后续优化建议

1. 添加可配置的上传频率（目前硬编码为每小时一个）
2. 支持手动暂停/恢复上传调度器
3. 添加更详细的任务执行日志和统计信息
4. 支持按优先级上传视频
5. 添加上传队列预览功能
